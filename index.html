<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>米飯感官評測儀表板 | Rice Sensory Evaluation Dashboard</title>
    
    <!-- 所有的 CSS 和 JS 庫都透過 CDN 載入，非常適合靜態網站託管 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <style>
        /* 自定義樣式 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f5f5f4; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; 
            margin-left: auto;
            margin-right: auto;
            height: 350px; 
            max-height: 400px;
        }
        @media (max-width: 640px) {
            .chart-container { height: 280px; }
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px; 
            height: 18px;
            border-radius: 50%;
            background: #0d9488;
            cursor: pointer;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
            margin-top: -8px; 
        }
        input[type="range"] {
             height: 4px;
             margin-top: 4px;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 font-sans leading-relaxed selection:bg-teal-100 selection:text-teal-900">

    <!-- Header & Navigation -->
    <header class="bg-white border-b border-stone-200 shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-teal-600 rounded-full flex items-center justify-center text-white font-bold text-xl">米</div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-stone-900 tracking-tight">米飯感官評測</h1>
                    <p class="text-xs text-stone-500 uppercase tracking-wider hidden sm:block">Rice Blind Tasting Assessment</p>
                </div>
            </div>
            <div class="flex space-x-2 sm:space-x-3">
                
                <button id="showQrCodeBtn" class="text-sm text-stone-500 hover:text-teal-600 transition-colors flex items-center gap-1 p-2 rounded-lg hover:bg-stone-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v2H3V5zm0 4h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2v-7zm7 3a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                    </svg>
                    <span class="hidden sm:inline">顯示 QR Code</span>
                </button>

                <button id="resetBtn" class="text-sm text-stone-500 hover:text-teal-600 transition-colors flex items-center gap-1 p-2 rounded-lg hover:bg-stone-100">
                    <span>&#10227;</span> <span class="hidden sm:inline">重置</span>
                </button>
                
                <!-- 提交數據按鈕 (取代 CSV) -->
                <button id="submitBtn" class="bg-teal-600 hover:bg-teal-700 text-white text-sm font-medium py-2 px-3 sm:px-4 rounded-lg shadow-md transition-colors flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M7.707 10.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h-2v5.586l-.293-.293z" />
                        <path d="M12 2H8a2 2 0 00-2 2v2a2 2 0 002 2h4a2 2 0 002-2V4a2 2 0 00-2-2z" />
                    </svg>
                    <span id="submitBtnText">提交數據至 Google Sheet</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 md:py-8 space-y-8 md:space-y-12">

        <!-- Intro Section -->
        <section class="max-w-4xl mx-auto text-center space-y-3">
            <h2 class="text-2xl md:text-3xl font-bold text-stone-800">半成品(米飯)盲測評分標準</h2>
            <p class="text-base text-stone-600 max-w-2xl mx-auto">
                請透過六大感官指標（外觀、氣味、軟硬、粘度、彈力、味道）對樣品進行全方位評估。
            </p>
        </section>

        <!-- Dashboard Grid: Mobile-first stacking, then 2 columns on desktop -->
        <div class="grid grid-cols-1 lg:col-span-12 gap-8">
            
            <!-- Left Column: Input Form (Priority on mobile) -->
            <div class="lg:col-span-5 order-first lg:order-none space-y-6">
                <div class="bg-white rounded-2xl shadow-xl border border-stone-200 p-5 sm:p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-teal-800 flex items-center gap-2">
                            <span>&#9998;</span> 評測數據輸入
                        </h3>
                        <span class="text-xs font-mono bg-stone-100 text-stone-500 px-2 py-1 rounded" id="currentSampleIdDisplay">Sample: C-03 (測試)</span>
                    </div>

                    <!-- Meta Data -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="input-assessor" class="block text-xs font-semibold text-stone-500 mb-1">評測者 (Assessor)</label>
                            <input type="text" id="input-assessor" value="評測員 C" class="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                        </div>
                        <div>
                            <label for="input-id" class="block text-xs font-semibold text-stone-500 mb-1">樣品編號 (ID)</label>
                            <input type="text" id="input-id" value="C-03 (測試)" class="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                        </div>
                    </div>

                    <div class="space-y-5">
                        <!-- Appearance -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-medium text-stone-700">外觀 (Appearance)</label>
                                <span class="text-sm font-bold text-teal-600" id="val-appearance">3</span>
                            </div>
                            <input type="range" min="1" max="5" step="1" value="3" id="input-appearance" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                            <p class="text-xs text-stone-400 mt-1">完整度、色澤、光澤</p>
                        </div>

                        <!-- Aroma -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-medium text-stone-700">氣味 (Aroma)</label>
                                <span class="text-sm font-bold text-teal-600" id="val-aroma">3</span>
                            </div>
                            <input type="range" min="1" max="5" step="1" value="3" id="input-aroma" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                            <p class="text-xs text-stone-400 mt-1">米飯香味、新鮮度</p>
                        </div>

                        <!-- Texture -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-medium text-stone-700">軟硬 (Texture)</label>
                                <span class="text-sm font-bold text-teal-600" id="val-texture">3</span>
                            </div>
                            <input type="range" min="1" max="5" step="1" value="3" id="input-texture" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                            <p class="text-xs text-stone-400 mt-1">米粒軟硬度</p>
                        </div>

                        <!-- Viscosity -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-medium text-stone-700">粘度 (Viscosity)</label>
                                <span class="text-sm font-bold text-teal-600" id="val-viscosity">3</span>
                            </div>
                            <input type="range" min="1" max="5" step="1" value="3" id="input-viscosity" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                            <p class="text-xs text-stone-400 mt-1">米飯黏性、抱團性</p>
                        </div>

                        <!-- Elasticity -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-medium text-stone-700">彈力 (Elasticity)</label>
                                <span class="text-sm font-bold text-teal-600" id="val-elasticity">3</span>
                            </div>
                            <input type="range" min="1" max="5" step="1" value="3" id="input-elasticity" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                            <p class="text-xs text-stone-400 mt-1">米飯彈性、咀嚼感</p>
                        </div>

                        <!-- Taste -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-medium text-stone-700">味道 (Taste)</label>
                                <span class="text-sm font-bold text-teal-600" id="val-taste">3</span>
                            </div>
                            <input type="range" min="1" max="5" step="1" value="3" id="input-taste" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                            <p class="text-xs text-stone-400 mt-1">米飯甜度、鮮味</p>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-stone-200">
                        <label for="input-score" class="block text-sm font-bold text-stone-700 mb-2">整體分數 (Overall Score)</label>
                        <div class="flex items-center gap-4">
                            <input type="number" id="input-score" value="75" min="0" max="100" class="w-24 text-2xl font-bold text-center text-teal-700 border-2 border-teal-100 rounded-lg py-2 focus:outline-none focus:border-teal-500">
                            <span class="text-stone-400">/ 100</span>
                        </div>
                    </div>

                     <div class="mt-6">
                        <label for="input-comments" class="block text-sm font-bold text-stone-700 mb-2">樣品評價內容 (Comments)</label>
                        <textarea id="input-comments" class="w-full h-24 bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm focus:outline-none focus:border-teal-500 resize-none" placeholder="描述優缺點、特殊風味..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Right Column: Visualization (Second on mobile, next to form on desktop) -->
            <div class="lg:col-span-7 order-last lg:order-none space-y-6">
                
                <!-- Radar Chart Card -->
                <div class="bg-white rounded-2xl shadow-xl border border-stone-200 p-5 sm:p-6 flex flex-col h-full">
                    <div class="mb-4">
                        <h3 class="text-xl font-bold text-teal-800">感官輪廓分析 (Sensory Profile)</h3>
                    </div>
                    
                    <div class="flex-grow flex items-center justify-center bg-stone-50 rounded-xl p-4 border border-stone-100">
                        <div class="chart-container">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-center gap-2 text-center text-xs text-stone-500">
                         <div class="flex items-center justify-center gap-1">
                            <span class="w-3 h-3 rounded-full bg-teal-600 border border-teal-800"></span> 當前評測樣品
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- QR Code Modal/Section -->
        <div id="qrCodeDisplaySection" class="fixed inset-0 bg-stone-900 bg-opacity-70 z-[99] items-center justify-center hidden" role="dialog" aria-modal="true">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm mx-auto transform transition-all">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-bold text-teal-800">手機掃碼填寫問卷</h4>
                    <button id="closeQrCodeBtn" class="text-stone-400 hover:text-stone-600 transition-colors text-2xl leading-none">&times;</button>
                </div>

                <div class="bg-red-50 border-l-4 border-red-400 p-3 mb-4 rounded-md">
                    <p class="text-sm font-semibold text-red-700">【重要提示】</p>
                    <p class="text-xs text-red-600 mt-1">
                        若掃描失敗，請使用「點擊複製網址」按鈕，將網址貼到手機上開啟。
                    </p>
                </div>

                <div class="text-center space-y-3">
                    <div id="qrcode" class="p-3 bg-white border border-stone-200 inline-block rounded-lg shadow-inner">
                        <!-- QR Code 會在此處生成 -->
                    </div>
                    
                    <p class="text-xs text-stone-500 break-words pt-2 font-mono" id="qrCodeUrlDisplay"></p>
                    
                    <button id="copyUrlBtn" class="w-full bg-teal-500 hover:bg-teal-600 text-white text-sm font-medium py-2 px-4 rounded-lg shadow-md transition-colors mt-4">
                        點擊複製網址
                    </button>
                    <p id="copyMessage" class="text-xs text-green-600 mt-2 h-4"></p>
                </div>
            </div>
        </div>

        <!-- Submission Feedback Modal -->
        <div id="feedbackModal" class="fixed inset-0 bg-stone-900 bg-opacity-70 z-[100] items-center justify-center hidden" role="dialog" aria-modal="true">
            <div class="bg-white rounded-xl shadow-2xl p-8 w-11/12 max-w-xs mx-auto text-center transform transition-all space-y-4">
                <div id="feedbackIcon" class="text-5xl text-teal-600"></div>
                <h4 id="feedbackTitle" class="text-xl font-bold text-stone-800"></h4>
                <p id="feedbackMessage" class="text-sm text-stone-600"></p>
                <button onclick="document.getElementById('feedbackModal').classList.add('hidden'); document.getElementById('feedbackModal').classList.remove('flex');" class="bg-teal-600 hover:bg-teal-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors">確認</button>
            </div>
        </div>


        <!-- Reference Guide (Scoring Notes) -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-red-50 border border-red-100 rounded-xl p-5 hover:shadow-md transition-shadow">
                <div class="flex items-center gap-3 mb-2">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-600 font-bold">1</span>
                    <h4 class="font-bold text-red-800">極差 (Poor)</h4>
                </div>
                <p class="text-sm text-red-700 leading-snug">無法接受的品質或特性。例如：有異味、夾生、色澤灰暗。</p>
            </div>

            <div class="bg-yellow-50 border border-yellow-100 rounded-xl p-5 hover:shadow-md transition-shadow">
                 <div class="flex items-center gap-3 mb-2">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-yellow-100 text-yellow-700 font-bold">3</span>
                    <h4 class="font-bold text-yellow-800">普通 (Average)</h4>
                </div>
                <p class="text-sm text-yellow-800 leading-snug">品質尚可，達到基本食用標準，但沒有突出的優點或明顯的記憶點。</p>
            </div>

             <div class="bg-teal-50 border border-teal-100 rounded-xl p-5 hover:shadow-md transition-shadow">
                 <div class="flex items-center gap-3 mb-2">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-teal-100 text-teal-700 font-bold">5</span>
                    <h4 class="font-bold text-teal-800">極佳 (Excellent)</h4>
                </div>
                <p class="text-sm text-teal-800 leading-snug">頂級品質，特性完美。例如：光澤誘人、香氣濃郁、口感絕佳。</p>
            </div>
        </section>

    </main>

    <footer class="bg-stone-800 text-stone-400 py-6 mt-12">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; 2025 Rice Blind Tasting Assessment System.</p>
        </div>
    </footer>

    <!-- Javascript Logic -->
    <script>
        // *** 重要設定：請將您的 Google Apps Script 部署網址替換此處的佔位符 ***
        // 此 URL 用於接收表單提交的數據並寫入 Google Sheet。
        const GOOGLE_APP_SCRIPT_URL = 'YOUR_DEPLOYED_WEB_APP_URL_HERE'; 
        // ***************************************************************
        
        let currentSample = {
            assessor: "評測員 C",
            id: "C-03 (測試)",
            name: "當前評測",
            scores: { appearance: 3, aroma: 3, texture: 3, viscosity: 3, elasticity: 3, taste: 3 },
            total: 75,
            comments: ""
        };

        let radarChartInstance = null;
        let isSubmitting = false;

        function getCurrentSampleData() {
            // 從輸入欄位抓取最新的數據
            currentSample.assessor = document.getElementById('input-assessor').value.trim();
            currentSample.id = document.getElementById('input-id').value.trim();
            currentSample.total = parseInt(document.getElementById('input-score').value) || 0;
            currentSample.comments = document.getElementById('input-comments').value.trim(); 
            
            const inputs = ['appearance', 'aroma', 'texture', 'viscosity', 'elasticity', 'taste'];
            inputs.forEach(key => {
                // 確保數值是整數
                currentSample.scores[key] = Math.round(parseFloat(document.getElementById(`input-${key}`).value));
            });

            return currentSample;
        }

        function initCharts() {
            const ctxRadar = document.getElementById('radarChart').getContext('2d');
            radarChartInstance = new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: ['外觀', '氣味', '軟硬', '粘度', '彈力', '味道'],
                    datasets: [
                        {
                            label: '當前評測',
                            data: Object.values(currentSample.scores),
                            borderColor: 'rgba(13, 148, 136, 1)', 
                            backgroundColor: 'rgba(13, 148, 136, 0.4)',
                            borderWidth: 2,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: 'rgba(13, 148, 136, 1)',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(13, 148, 136, 1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 5,
                            ticks: { stepSize: 1, display: false },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            angleLines: { color: 'rgba(0, 0, 0, 0.05)' },
                            pointLabels: {
                                font: { size: 12, family: "'Noto Sans TC', sans-serif" },
                                color: '#44403c'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#111',
                            bodyColor: '#333',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 10
                        }
                    }
                }
            });
        }
        
        /**
         * 提交數據到 Google Sheets via Apps Script
         */
        async function submitDataToGoogleSheet() {
            if (isSubmitting) return;

            if (GOOGLE_APP_SCRIPT_URL === 'YOUR_DEPLOYED_WEB_APP_URL_HERE' || !GOOGLE_APP_SCRIPT_URL.startsWith('http')) {
                showFeedback('錯誤', '請先完成 Apps Script 設定！', '&#10060;', 'text-red-500');
                return;
            }
            
            const data = getCurrentSampleData();
            
            // 基礎資料驗證
            if (!data.assessor || !data.id || data.total === 0) {
                 showFeedback('錯誤', '請填寫評測者、樣品編號及整體分數！', '&#10060;', 'text-red-500');
                 return;
            }

            isSubmitting = true;
            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            
            // 禁用按鈕並顯示載入中
            submitBtn.disabled = true;
            submitBtn.classList.remove('bg-teal-600', 'hover:bg-teal-700');
            submitBtn.classList.add('bg-teal-300', 'cursor-not-allowed');
            submitBtnText.innerText = '提交中...';


            // 準備 Apps Script 需要的格式
            const payload = {
                timestamp: new Date().toISOString(), 
                assessor: data.assessor,
                id: data.id,
                appearance: data.scores.appearance,
                aroma: data.scores.aroma,
                texture: data.scores.texture,
                viscosity: data.scores.viscosity,
                elasticity: data.scores.elasticity,
                taste: data.scores.taste,
                total: data.total,
                comments: data.comments
            };

            try {
                // 使用 Apps Script 的標準 POST 方式 (通常需要 no-cors 模式)
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                // 由於是 'no-cors' 模式，我們只能假設如果沒有網路錯誤，提交是成功的。
                // 實際的成功/失敗判斷需要依賴 Apps Script 的邏輯，但前端無法得知狀態碼。
                
                showFeedback('提交成功', `樣品 ${data.id} 的評測數據已成功記錄！`, '&#9989;', 'text-teal-600');
                
                // 提交成功後，可以選擇重置表單
                document.getElementById('resetBtn').click(); 

            } catch (error) {
                console.error('Submission Error:', error);
                showFeedback('提交失敗', '網路錯誤或 Apps Script 部署有問題。請檢查控制台。', '&#10060;', 'text-red-500');
            } finally {
                // 恢復按鈕狀態
                isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-teal-300', 'cursor-not-allowed');
                submitBtn.classList.add('bg-teal-600', 'hover:bg-teal-700');
                submitBtnText.innerText = '提交數據至 Google Sheet';
            }
        }

        /**
         * 顯示自定義的 Feedback Modal
         */
        function showFeedback(title, message, iconHtml, iconColorClass) {
            const modal = document.getElementById('feedbackModal');
            document.getElementById('feedbackTitle').innerText = title;
            document.getElementById('feedbackMessage').innerText = message;
            
            const icon = document.getElementById('feedbackIcon');
            icon.innerHTML = iconHtml;
            icon.className = `text-5xl ${iconColorClass}`;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // --- QR Code Logic (不變) ---
        function generateQRCode() {
            const qrCodeContainer = document.getElementById('qrcode');
            qrCodeContainer.innerHTML = '';
            // 在 GitHub Pages 上，window.location.href 就是部署後的 URL
            const url = window.location.href; 
            document.getElementById('qrCodeUrlDisplay').innerText = url;
            const copyMessage = document.getElementById('copyMessage');
            copyMessage.innerText = '';

            if (typeof QRCode !== 'undefined') {
                try {
                    if (qrCodeContainer.querySelector('canvas')) {
                        qrCodeContainer.innerHTML = ''; 
                    }
                    
                    new QRCode(qrCodeContainer, {
                        text: url,
                        width: 150,
                        height: 150,
                        colorDark : "#0d9488", 
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                    
                } catch (error) {
                    qrCodeContainer.innerHTML = '<p class="text-sm text-red-500">QR Code 生成失敗，請手動複製下方網址。</p>';
                }
            } else {
                 qrCodeContainer.innerHTML = '<p class="text-sm text-red-500">QR Code 函式庫未載入，請手動複製下方網址。</p>';
            }
        }
        
        function copyUrlToClipboard() {
            const url = window.location.href;
            const copyMessage = document.getElementById('copyMessage');
            
            // 嘗試使用現代 Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                 navigator.clipboard.writeText(url).then(() => {
                    copyMessage.innerText = '網址已複製到剪貼簿！';
                    setTimeout(() => copyMessage.innerText = '', 2000);
                }).catch(() => {
                    fallbackCopyTextToClipboard(url, copyMessage);
                });
            } else {
                 // 針對不支援的瀏覽器使用後備方案
                fallbackCopyTextToClipboard(url, copyMessage);
            }
        }
        
        // 後備複製功能，使用 document.execCommand
        function fallbackCopyTextToClipboard(text, copyMessage) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";  
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                // execCommand 已經被棄用，但作為後備方案仍能運作
                document.execCommand('copy');
                copyMessage.innerText = '網址已複製到剪貼簿！ (後備)';
            } catch (err) {
                copyMessage.innerText = '複製失敗，請手動選取網址。';
            }

            document.body.removeChild(textArea);
            setTimeout(() => copyMessage.innerText = '', 2000);
        }

        // --- Listeners & Init ---
        function setupListeners() {
            const inputs = ['appearance', 'aroma', 'texture', 'viscosity', 'elasticity', 'taste'];
            inputs.forEach(key => {
                const slider = document.getElementById(`input-${key}`);
                const display = document.getElementById(`val-${key}`);
                slider.addEventListener('input', (e) => {
                    const val = Math.round(parseFloat(e.target.value)); 
                    display.innerText = val;
                    currentSample.scores[key] = val;
                    updateDashboard();
                });
            });

            ['input-score', 'input-assessor', 'input-id', 'input-comments'].forEach(id => {
                 document.getElementById(id).addEventListener('input', updateDashboard);
            });

            document.getElementById('resetBtn').addEventListener('click', () => {
                inputs.forEach(key => {
                    document.getElementById(`input-${key}`).value = 3;
                    document.getElementById(`val-${key}`).innerText = 3;
                });
                document.getElementById('input-score').value = 75;
                document.getElementById('input-assessor').value = "評測員 C";
                document.getElementById('input-id').value = "C-03 (測試)";
                document.getElementById('input-comments').value = "";
                updateDashboard();
            });

            // 設置提交按鈕的監聽器
            document.getElementById('submitBtn').addEventListener('click', submitDataToGoogleSheet);
            
            const qrCodeModal = document.getElementById('qrCodeDisplaySection');
            document.getElementById('showQrCodeBtn').addEventListener('click', () => {
                generateQRCode(); 
                qrCodeModal.classList.remove('hidden');
                qrCodeModal.classList.add('flex');
            });
            document.getElementById('copyUrlBtn').addEventListener('click', copyUrlToClipboard);
            document.getElementById('closeQrCodeBtn').addEventListener('click', () => {
                qrCodeModal.classList.add('hidden');
                qrCodeModal.classList.remove('flex');
            });
            // 點擊背景關閉 Modal
            qrCodeModal.addEventListener('click', (e) => {
                if (e.target === qrCodeModal) {
                    qrCodeModal.classList.add('hidden');
                    qrCodeModal.classList.remove('flex');
                }
            });
        }

        function updateDashboard() {
            const currentData = getCurrentSampleData();
            document.getElementById('currentSampleIdDisplay').innerText = `Sample: ${currentData.id}`;
            radarChartInstance.data.datasets[0].data = Object.values(currentData.scores);
            radarChartInstance.update();
        }

        window.addEventListener('DOMContentLoaded', () => {
            // 初始化表單值
            document.getElementById('input-assessor').value = currentSample.assessor;
            document.getElementById('input-id').value = currentSample.id;
            document.getElementById('input-score').value = currentSample.total;
            
             const inputs = ['appearance', 'aroma', 'texture', 'viscosity', 'elasticity', 'taste'];
             inputs.forEach(key => {
                 document.getElementById(`input-${key}`).value = currentSample.scores[key];
                 document.getElementById(`val-${key}`).innerText = currentSample.scores[key];
             });

            initCharts();
            setupListeners();
        });

    </script>
</body>
</html>